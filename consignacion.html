<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CONSIGNACIONES 2026 â€” GELM</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --gelm-cyan: #00eaff;
      --gelm-magenta: #b300ff;
      --gelm-bg: #020510;
    }

    body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: var(--gelm-bg); color: white; padding: 10px; }
    .agenda-panel { background: rgba(3, 5, 20, 0.96); border-radius: 20px; border: 1px solid rgba(0, 234, 255, 0.3); padding: 15px; max-width: 800px; margin: auto; }
    
    header { text-align: center; margin-bottom: 20px; border-bottom: 2px solid var(--gelm-cyan); }
    .modulo-titulo { color: var(--gelm-cyan); font-size: 0.75rem; font-weight: bold; text-transform: uppercase; margin: 15px 0 8px 0; display: flex; align-items: center; }
    .modulo-titulo::before { content: ""; width: 4px; height: 15px; background: var(--gelm-magenta); margin-right: 8px; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .full { grid-column: 1 / -1; }
    
    label { font-size: 0.65rem; color: #00eaff; margin-bottom: 3px; display: block; text-transform: uppercase; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; font-size: 16px; } /* 16px evita zoom en iPhone */

    .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn { padding: 15px; border-radius: 12px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; font-size: 14px; }
    .btn-save { background: #00eaff; color: #000; grid-column: 1 / -1; }
    .btn-excel { background: #22c55e; color: white; }
    .btn-pdf { background: #b300ff; color: white; }

    .table-wrapper { overflow-x: auto; margin-top: 25px; border-radius: 10px; }
    table { width: 100%; border-collapse: collapse; font-size: 0.8rem; background: rgba(255,255,255,0.02); }
    th { background: #00eaff; color: #000; padding: 10px; text-align: left; }
    td { padding: 10px; border-bottom: 1px solid #222; }
    .img-mini { width: 50px; height: 40px; border-radius: 4px; border: 1px solid #00eaff; }
    
    @media print {
      .btn, .modulo-titulo, .grid, label, input, select, textarea, th:last-child, td:last-child { display: none !important; }
      body { background: white; color: black; }
      .agenda-panel { border: none; width: 100%; }
      th { border: 1px solid black !important; background: #eee !important; }
      td { border: 1px solid #ddd !important; }
    }
  </style>
</head>
<body>

<div class="agenda-panel">
  <header>
    <h2 style="margin:5px; color:#00ffc8;">CONSIGNACIONES 2026</h2>
    <small>PMT CHIMALTENANGO</small>
  </header>

  <div class="modulo-titulo">Datos del Conductor</div>
  <div class="grid">
    <div class="full"><label>Piloto</label><input type="text" id="piloto" placeholder="Nombre completo"></div>
    <div><label>Licencia</label><input type="text" id="numLicencia" placeholder="No. Licencia"></div>
    <div><label>DPI</label><input type="text" id="dpi" placeholder="No. DPI"></div>
  </div>

  <div class="modulo-titulo">Datos del VehÃ­culo</div>
  <div class="grid">
    <div><label>Placa</label><input type="text" id="placa" placeholder="P-000XXX"></div>
    <div><label>Marca/Color</label><input type="text" id="marca" placeholder="Toyota Gris"></div>
    <div class="full"><label>NIT</label><input type="text" id="nit" placeholder="NIT del vehÃ­culo"></div>
  </div>

  <div class="modulo-titulo">Operativo</div>
  <div class="grid">
    <div><label>Fecha</label><input type="date" id="fecha"></div>
    <div><label>Hora</label><input type="time" id="hora"></div>
    <div><label>Agente</label><input type="text" id="agente" placeholder="Nombre"></div>
    <div><label>Chapa</label><input type="text" id="chapa" placeholder="No."></div>
    <div class="full"><label>Motivo</label><textarea id="motivo" rows="2"></textarea></div>
    <div class="full"><label>Foto Prueba</label><input type="file" id="foto" accept="image/*"></div>
  </div>

  <div class="controls">
    <button class="btn btn-save" onclick="guardarRegistro()">ðŸ’¾ GUARDAR CONSIGNACIÃ“N</button>
    <button class="btn btn-excel" onclick="exportarExcel()">ðŸ“Š EXCEL</button>
    <button class="btn btn-pdf" onclick="window.print()">ðŸ“‘ PDF</button>
  </div>

  <div class="table-wrapper">
    <table>
      <thead>
        <tr>
          <th>Fecha</th>
          <th>Placa</th>
          <th>Motivo</th>
          <th>Foto</th>
          <th>AcciÃ³n</th>
        </tr>
      </thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>
</div>

<script>
  const DB_KEY = "CONSIGNACIONES_GELM_2026";
  let db = JSON.parse(localStorage.getItem(DB_KEY)) || [];
  let temporalFoto = "";

  // Al cargar
  window.onload = () => {
    const n = new Date();
    document.getElementById('fecha').valueAsDate = n;
    document.getElementById('hora').value = n.getHours().toString().padStart(2,'0')+":"+n.getMinutes().toString().padStart(2,'0');
    actualizarTabla();
  };

  // Procesar Foto (IGUAL QUE BITACORA)
  document.getElementById("foto").onchange = function(e) {
    const reader = new FileReader();
    reader.onload = function(ev) {
      const img = new Image();
      img.onload = function() {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const max = 500;
        let w = img.width, h = img.height;
        if (w > h) { if (w > max) { h *= max/w; w = max; } }
        else { if (h > max) { w *= max/h; h = max; } }
        canvas.width = w; canvas.height = h;
        ctx.drawImage(img, 0, 0, w, h);
        temporalFoto = canvas.toDataURL('image/jpeg', 0.5);
      };
      img.src = ev.target.result;
    };
    if(e.target.files[0]) reader.readAsDataURL(e.target.files[0]);
  };

  function guardarRegistro() {
    const p = document.getElementById("piloto").value;
    const pl = document.getElementById("placa").value;
    if(!p || !pl) return alert("Escribe Piloto y Placa");

    const nuevo = {
      id: Date.now(),
      fecha: document.getElementById("fecha").value,
      hora: document.getElementById("hora").value,
      piloto: p,
      licencia: document.getElementById("numLicencia").value,
      dpi: document.getElementById("dpi").value,
      placa: pl.toUpperCase(),
      marca: document.getElementById("marca").value,
      nit: document.getElementById("nit").value,
      agente: document.getElementById("agente").value,
      chapa: document.getElementById("chapa").value,
      motivo: document.getElementById("motivo").value,
      foto: temporalFoto
    };

    db.push(nuevo);
    localStorage.setItem(DB_KEY, JSON.stringify(db));
    
    // Limpiar
    document.getElementById("piloto").value = "";
    document.getElementById("placa").value = "";
    document.getElementById("motivo").value = "";
    temporalFoto = "";
    document.getElementById("foto").value = "";

    actualizarTabla();
    alert("Â¡Guardado exitosamente!");
  }

  function actualizarTabla() {
    const tbody = document.getElementById("tablaBody");
    tbody.innerHTML = "";
    
    db.slice().reverse().forEach((r, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.fecha}<br>${r.hora}</td>
        <td><b>${r.placa}</b></td>
        <td>${r.motivo.substring(0,20)}...</td>
        <td>${r.foto ? `<img src="${r.foto}" class="img-mini">` : 'â€”'}</td>
        <td><button onclick="borrar(${db.length - 1 - idx})" style="background:red; color:white; border:none; border-radius:4px; padding:5px;">X</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  function borrar(i) {
    if(confirm("Â¿Borrar?")) {
      db.splice(i, 1);
      localStorage.setItem(DB_KEY, JSON.stringify(db));
      actualizarTabla();
    }
  }

  function exportarExcel() {
    if(db.length === 0) return alert("No hay datos");
    // Quitamos la foto para el excel porque los mÃ³viles no aguantan imÃ¡genes dentro de celdas excel
    const datosSinFoto = db.map(item => {
      const { foto, id, ...resto } = item;
      return resto;
    });
    const ws = XLSX.utils.json_to_sheet(datosSinFoto);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Consignaciones");
    XLSX.writeFile(wb, "Consignaciones_2026.xlsx");
  }
</script>

</body>
</html>
