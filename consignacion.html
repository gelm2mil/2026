<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CONSIGNACIONES â€” PMT TRANSPORTES</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --pmt-cyan: #00eaff; --pmt-bg: #020510; }
    body { background: var(--pmt-bg); color: #e0f7ff; font-family: sans-serif; margin: 0; padding: 10px; }
    .container { max-width: 900px; margin: auto; }
    .card { background: rgba(10, 20, 40, 0.95); border: 1px solid rgba(0, 234, 255, 0.3); border-radius: 20px; padding: 20px; margin-bottom: 20px; }
    
    h2 { color: var(--pmt-cyan); border-bottom: 2px solid var(--pmt-cyan); padding-bottom: 8px; font-size: 1rem; text-transform: uppercase; }
    .modulo { border: 1px solid rgba(255,255,255,0.1); padding: 15px; border-radius: 15px; margin-bottom: 15px; background: rgba(0,0,0,0.2); }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .full { grid-column: 1 / -1; }
    
    label { display: block; font-size: 0.7rem; color: var(--pmt-cyan); margin-bottom: 4px; text-transform: uppercase; }
    input, select, textarea { width: 100%; padding: 10px; background: #000; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; }

    /* Licencias en cuadritos */
    .licencia-grid { display: flex; gap: 10px; margin-top: 5px; }
    .lic-item { display: flex; align-items: center; gap: 5px; background: #111; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; }

    /* Inventario con texto */
    .inv-row { display: grid; grid-template-columns: 140px 1fr; gap: 10px; align-items: center; margin-bottom: 5px; border-bottom: 1px solid #222; padding-bottom: 5px; }
    .inv-row span { font-size: 0.8rem; }

    .btn { padding: 12px; border-radius: 25px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.75rem; }
    .btn-save { background: var(--pmt-cyan); color: #000; width: 100%; margin-top: 10px; }
    .btn-excel { background: #1d6f42; color: white; }
    .btn-del { background: #ff0044; color: white; padding: 5px 10px; border-radius: 5px; }
    .btn-print { background: #b300ff; color: white; padding: 5px 10px; border-radius: 5px; }

    table { width: 100%; border-collapse: collapse; font-size: 0.75rem; margin-top: 10px; }
    th { background: #111; color: var(--pmt-cyan); padding: 8px; text-align: left; }
    td { padding: 8px; border-bottom: 1px solid #222; }

    /* IMPRESIÃ“N */
    #printArea { display: none; }
    @media print {
      body * { display: none; }
      #printArea { display: block !important; color: black; background: white; padding: 20px; }
      .membrete { width: 100%; margin-bottom: 10px; }
      .print-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; border: 1px solid black; padding: 10px; }
      .foto-p { max-width: 300px; margin-top: 10px; border: 1px solid #000; }
    }
  </style>
</head>
<body>

<div class="container">
  <div class="card">
    <h2 style="text-align: center;">Formulario de ConsignaciÃ³n Oficial</h2>
    
    <div class="modulo">
      <label>Datos del Conductor</label>
      <input type="text" id="conductor" placeholder="Nombre completo" class="full">
      <div class="grid" style="margin-top:10px;">
        <input type="text" id="licencia_num" placeholder="No. de Licencia">
        <input type="text" id="dpi" placeholder="No. de DPI">
      </div>
      <div class="licencia-grid">
        <span style="font-size:0.7rem;">TIPO:</span>
        <label class="lic-item"><input type="radio" name="tipoLic" value="A"> A</label>
        <label class="lic-item"><input type="radio" name="tipoLic" value="B"> B</label>
        <label class="lic-item"><input type="radio" name="tipoLic" value="C"> C</label>
        <label class="lic-item"><input type="radio" name="tipoLic" value="E"> E</label>
        <label class="lic-item"><input type="radio" name="tipoLic" value="M"> M</label>
      </div>
    </div>

    <div class="modulo">
      <label>Datos del VehÃ­culo</label>
      <div class="grid">
        <input type="text" id="placas" placeholder="Placas">
        <input type="text" id="tipo_v" placeholder="Tipo (Moto, Sedan, etc)">
        <input type="text" id="marca" placeholder="Marca">
        <input type="text" id="color" placeholder="Color">
        <input type="text" id="nit" placeholder="NIT" class="full">
      </div>
    </div>

    <div class="modulo">
      <label>Inventario y Equipo (Marque y comente)</label>
      <div id="listaInventario">
        </div>
    </div>

    <div class="modulo">
      <div class="grid">
        <div><label>Fecha</label><input type="date" id="fecha"></div>
        <div><label>Hora</label><input type="time" id="hora"></div>
        <input type="text" id="agente" placeholder="Nombre del Agente" class="full">
        <input type="text" id="chapa" placeholder="No. de Chapa" class="full">
        <textarea id="motivo" placeholder="Motivo de la consignaciÃ³n" class="full" rows="2"></textarea>
      </div>
      <label style="margin-top:10px;">Evidencia DaÃ±os</label>
      <input type="file" id="fotoInput" accept="image/*">
    </div>

    <button class="btn btn-save" onclick="guardar()">ðŸ’¾ Guardar Registro</button>
  </div>

  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <h2>Registros Guardados</h2>
      <button class="btn btn-excel" onclick="exportarExcel()">ðŸ“Š Excel</button>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead><tr><th>Fecha</th><th>Placas</th><th>Conductor</th><th>Acciones</th></tr></thead>
        <tbody id="tablaBody"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="printArea">
  <img src="icons/membrete_2026.jpg" class="membrete">
  <h2 style="text-align:center; color:black;">BOLETA DE CONSIGNACIÃ“N - PMT</h2>
  <div id="p-content" class="print-grid"></div>
  <div id="p-inv" style="margin-top:15px; font-size:12px;"></div>
  <div id="p-foto" style="text-align:center;"></div>
  <div style="margin-top:60px; display:flex; justify-content:space-around; text-align:center; font-size:12px;">
    <div>_______________________<br>Agente Consignatario</div>
    <div>_______________________<br>Conductor / Recibido</div>
  </div>
</div>

<script>
  const ITEMS = ["Antena", "Radio", "Bocinas", "Espejos", "Alfombras", "Llanta Repuesto", "Tricket", "Herramientas", "Tapaderas/Copas"];
  const DB_KEY = 'respaldo_total_gelm';
  let dataStorage = JSON.parse(localStorage.getItem(DB_KEY)) || [];
  let tempFoto = "";

  // Generar inventario en pantalla
  const invBox = document.getElementById('listaInventario');
  ITEMS.forEach(item => {
    invBox.innerHTML += `
      <div class="inv-row">
        <span><input type="checkbox" class="chk-inv" data-item="${item}"> ${item}</span>
        <input type="text" class="txt-inv" data-item="${item}" placeholder="Estado / Obs.">
      </div>`;
  });

  // Procesar Foto
  document.getElementById('fotoInput').onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = 500; canvas.height = img.height * (500/img.width);
        canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
        tempFoto = canvas.toDataURL('image/jpeg', 0.6);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  function guardar() {
    const lic = document.querySelector('input[name="tipoLic"]:checked')?.value || "";
    const invData = [];
    document.querySelectorAll('.chk-inv:checked').forEach(chk => {
      const obs = document.querySelector(`.txt-inv[data-item="${chk.dataset.item}"]`).value;
      invData.push(`${chk.dataset.item}: ${obs}`);
    });

    const d = {
      id: Date.now(),
      conductor: document.getElementById('conductor').value,
      licencia_num: document.getElementById('licencia_num').value,
      tipo_lic: lic,
      dpi: document.getElementById('dpi').value,
      placas: document.getElementById('placas').value,
      marca: document.getElementById('marca').value,
      color: document.getElementById('color').value,
      fecha: document.getElementById('fecha').value,
      hora: document.getElementById('hora').value,
      agente: document.getElementById('agente').value,
      chapa: document.getElementById('chapa').value,
      motivo: document.getElementById('motivo').value,
      inventario: invData,
      foto: tempFoto
    };

    if(!d.placas) return alert("Falta Placa");
    dataStorage.push(d);
    localStorage.setItem(DB_KEY, JSON.stringify(dataStorage));
    alert("Guardado correctamente");
    location.reload();
  }

  function render() {
    const t = document.getElementById('tablaBody');
    t.innerHTML = "";
    dataStorage.forEach((d, i) => {
      t.innerHTML += `
        <tr>
          <td>${d.fecha}</td>
          <td><b>${d.placas}</b></td>
          <td>${d.conductor}</td>
          <td>
            <button class="btn-print" onclick="imprimir(${i})">PDF</button>
            <button class="btn-del" onclick="borrar(${i})">X</button>
          </td>
        </tr>`;
    });
  }

  function borrar(i) {
    if(confirm("Â¿Borrar este registro?")) {
      dataStorage.splice(i, 1);
      localStorage.setItem(DB_KEY, JSON.stringify(dataStorage));
      render();
    }
  }

  function imprimir(i) {
    const d = dataStorage[i];
    document.getElementById('p-content').innerHTML = `
      <div><b>CONDUCTOR:</b> ${d.conductor}</div>
      <div><b>LICENCIA:</b> ${d.tipo_lic} - ${d.licencia_num}</div>
      <div><b>PLACAS:</b> ${d.placas}</div>
      <div><b>MARCA/COLOR:</b> ${d.marca} / ${d.color}</div>
      <div><b>FECHA/HORA:</b> ${d.fecha} ${d.hora}</div>
      <div><b>AGENTE:</b> ${d.agente} (CHAPA ${d.chapa})</div>
      <div style="grid-column: 1/-1"><b>MOTIVO:</b> ${d.motivo}</div>
    `;
    document.getElementById('p-inv').innerHTML = "<b>INVENTARIO:</b> " + d.inventario.join(' | ');
    document.getElementById('p-foto').innerHTML = d.foto ? `<img src="${d.foto}" class="foto-p">` : '';
    
    setTimeout(() => { window.print(); }, 500);
  }

  function exportarExcel() {
    const ws = XLSX.utils.json_to_sheet(dataStorage);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Consignaciones");
    XLSX.writeFile(wb, "Reporte_Consignaciones_2026.xlsx");
  }

  render();
</script>
</body>
</html>
