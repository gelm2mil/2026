<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CONSIGNACIONES PMT 2026</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root { --cyan: #00eaff; --magenta: #b300ff; --bg: #020510; }
    body { margin: 0; font-family: sans-serif; background: var(--bg); color: white; padding: 10px; }
    .shell { max-width: 800px; margin: auto; background: rgba(3, 5, 20, 0.95); border: 1px solid #00eaff44; border-radius: 20px; padding: 15px; }
    
    header { text-align: center; border-bottom: 2px solid var(--cyan); margin-bottom: 20px; }
    .sec-t { color: var(--cyan); font-size: 11px; text-transform: uppercase; font-weight: bold; margin: 15px 0 5px; display: block; }
    
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .full { grid-column: 1 / -1; }
    
    input, select, textarea { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #333; background: #000; color: white; box-sizing: border-box; font-size: 16px; }
    .chk-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; background: #000; padding: 10px; border-radius: 8px; border: 1px solid #333; }
    .chk-item { font-size: 12px; display: flex; align-items: center; gap: 5px; }
    .chk-item input { width: 18px; height: 18px; }

    .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
    .btn { padding: 15px; border-radius: 12px; border: none; font-weight: bold; text-transform: uppercase; cursor: pointer; }
    .b-save { background: var(--cyan); color: #000; grid-column: 1 / -1; }
    .b-excel { background: #22c55e; color: white; }
    .b-pdf { background: var(--magenta); color: white; }

    /* TABLA */
    .table-w { overflow-x: auto; margin-top: 20px; }
    table { width: 100%; border-collapse: collapse; font-size: 12px; }
    th { background: var(--cyan); color: #000; padding: 8px; }
    td { padding: 8px; border-bottom: 1px solid #222; text-align: center; }
    .img-p { width: 45px; height: 35px; border: 1px solid var(--cyan); border-radius: 4px; }

    /* DISE√ëO BOLETA PDF (OCULTO EN PANTALLA) */
    #boleta-print { display: none; color: black; background: white; padding: 40px; }
    @media print {
      body * { visibility: hidden; }
      #boleta-print, #boleta-print * { visibility: visible; }
      #boleta-print { display: block; position: absolute; left: 0; top: 0; width: 100%; }
      .no-print { display: none; }
    }
  </style>
</head>
<body>

<div class="shell no-print">
  <header>
    <h2 style="margin:5px; color:var(--cyan);">CONSIGNACIONES 2026</h2>
    <small>UNIDAD DE TRANSPORTES ‚Äî CHIMAL</small>
  </header>

  <span class="sec-t">Datos del Conductor</span>
  <div class="grid">
    <input type="text" id="piloto" placeholder="Nombre Piloto" class="full">
    <input type="text" id="licencia" placeholder="No. Licencia">
    <select id="clase"><option>Clase A</option><option>Clase B</option><option>Clase C</option><option>Clase M</option></select>
    <input type="text" id="dpi" placeholder="DPI / Documento" class="full">
  </div>

  <span class="sec-t">Datos del Veh√≠culo</span>
  <div class="grid">
    <input type="text" id="placa" placeholder="Placas">
    <select id="tipoV"><option>Autom√≥vil</option><option>Motocicleta</option><option>Cami√≥n</option><option>Bus</option></select>
    <input type="text" id="marca" placeholder="Marca">
    <input type="text" id="color" placeholder="Color">
    <input type="text" id="nit" placeholder="NIT Veh√≠culo" class="full">
  </div>

  <span class="sec-t">Inventario</span>
  <div class="chk-group" id="inventario">
    <div class="chk-item"><input type="checkbox" value="Antena"> Antena</div>
    <div class="chk-item"><input type="checkbox" value="Radio"> Radio</div>
    <div class="chk-item"><input type="checkbox" value="Bocinas"> Bocinas</div>
    <div class="chk-item"><input type="checkbox" value="Espejos"> Espejos</div>
    <div class="chk-item"><input type="checkbox" value="Alfombras"> Alfombras</div>
    <div class="chk-item"><input type="checkbox" value="Llanta Rep."> Llanta Rep.</div>
  </div>

  <span class="sec-t">Operativo y Motivo</span>
  <div class="grid">
    <input type="date" id="fecha">
    <input type="text" id="agente" placeholder="Nombre Agente">
    <input type="text" id="chapa" placeholder="Chapa No.">
    <input type="text" id="boleta" placeholder="No. Boleta Infracci√≥n">
    <textarea id="motivo" placeholder="Motivo de la consignaci√≥n..." class="full" rows="2"></textarea>
    <input type="file" id="foto" accept="image/*" class="full">
  </div>

  <div class="btn-group">
    <button class="btn b-save" onclick="guardar()">üíæ GUARDAR REGISTRO</button>
    <button class="btn b-excel" onclick="excel()">üìä EXCEL</button>
    <button class="btn b-pdf" onclick="window.print()">üìë IMPRIMIR PDF</button>
  </div>

  <div class="table-w">
    <table>
      <thead><tr><th>Fecha</th><th>Placa</th><th>Acci√≥n</th></tr></thead>
      <tbody id="res"></tbody>
    </table>
  </div>
</div>

<div id="boleta-print">
  <center>
    <h3>POLIC√çA MUNICIPAL DE TR√ÅNSITO</h3>
    <h4>CHIMALTENANGO, GUATEMALA</h4>
    <p><b>BOLETA DE CONSIGNACI√ìN OFICIAL</b></p>
  </center>
  <table border="1" style="width:100%; border-collapse: collapse; margin-top:20px;">
    <tr><td colspan="2" bgcolor="#eee"><b>DATOS DEL CONDUCTOR</b></td></tr>
    <tr><td><b>NOMBRE:</b> <span id="p-nom"></span></td><td><b>DPI:</b> <span id="p-dpi"></span></td></tr>
    <tr><td><b>LICENCIA:</b> <span id="p-lic"></span></td><td><b>FECHA:</b> <span id="p-fec"></span></td></tr>
    <tr><td colspan="2" bgcolor="#eee"><b>DATOS DEL VEH√çCULO</b></td></tr>
    <tr><td><b>PLACA:</b> <span id="p-pla"></span></td><td><b>TIPO:</b> <span id="p-tip"></span></td></tr>
    <tr><td><b>MARCA:</b> <span id="p-mar"></span></td><td><b>COLOR:</b> <span id="p-col"></span></td></tr>
    <tr><td colspan="2"><b>NIT:</b> <span id="p-nit"></span></td></tr>
    <tr><td colspan="2" bgcolor="#eee"><b>CONSIGNACI√ìN</b></td></tr>
    <tr><td colspan="2"><b>MOTIVO:</b> <span id="p-mot"></span></td></tr>
    <tr><td><b>AGENTE:</b> <span id="p-age"></span></td><td><b>CHAPA:</b> <span id="p-cha"></span></td></tr>
    <tr><td colspan="2"><b>BOLETA INFRACCI√ìN:</b> <span id="p-bol"></span></td></tr>
  </table>
  <p style="font-size: 10px; margin-top:10px;"><b>INVENTARIO:</b> <span id="p-inv"></span></p>
  <center><img id="p-img" style="max-width:300px; margin-top:20px; border:1px solid #000;"></center>
  <div style="margin-top:50px; display:flex; justify-content: space-around;">
    <span>____________________<br>F. AGENTE</span>
    <span>____________________<br>F. CONDUCTOR</span>
  </div>
</div>

<script>
  let db = JSON.parse(localStorage.getItem("DATA_CONS_2026")) || [];
  let fData = "";

  window.onload = () => { 
    document.getElementById('fecha').valueAsDate = new Date(); 
    render(); 
  };

  document.getElementById("foto").onchange = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
      const img = new Image();
      img.onload = () => {
        const c = document.createElement('canvas');
        const ctx = c.getContext('2d');
        c.width = 400; c.height = img.height * (400/img.width);
        ctx.drawImage(img, 0, 0, c.width, c.height);
        fData = c.toDataURL('image/jpeg', 0.5);
      };
      img.src = ev.target.result;
    };
    reader.readAsDataURL(e.target.files[0]);
  };

  function guardar() {
    const inv = Array.from(document.querySelectorAll('#inventario input:checked')).map(c => c.value).join(", ");
    const r = {
      piloto: document.getElementById("piloto").value,
      licencia: document.getElementById("licencia").value + " ("+document.getElementById("clase").value+")",
      dpi: document.getElementById("dpi").value,
      placa: document.getElementById("placa").value.toUpperCase(),
      tipo: document.getElementById("tipoV").value,
      marca: document.getElementById("marca").value,
      color: document.getElementById("color").value,
      nit: document.getElementById("nit").value,
      fecha: document.getElementById("fecha").value,
      agente: document.getElementById("agente").value,
      chapa: document.getElementById("chapa").value,
      boleta: document.getElementById("boleta").value,
      motivo: document.getElementById("motivo").value,
      inventario: inv,
      foto: fData
    };

    if(!r.piloto || !r.placa) return alert("Nombre y Placa son obligatorios");
    
    db.push(r);
    localStorage.setItem("DATA_CONS_2026", JSON.stringify(db));
    prepPrint(r);
    render();
    alert("Guardado. Ahora puedes imprimir el PDF.");
  }

  function prepPrint(r) {
    document.getElementById("p-nom").innerText = r.piloto;
    document.getElementById("p-dpi").innerText = r.dpi;
    document.getElementById("p-lic").innerText = r.licencia;
    document.getElementById("p-fec").innerText = r.fecha;
    document.getElementById("p-pla").innerText = r.placa;
    document.getElementById("p-tip").innerText = r.tipo;
    document.getElementById("p-mar").innerText = r.marca;
    document.getElementById("p-col").innerText = r.color;
    document.getElementById("p-nit").innerText = r.nit;
    document.getElementById("p-mot").innerText = r.motivo;
    document.getElementById("p-age").innerText = r.agente;
    document.getElementById("p-cha").innerText = r.chapa;
    document.getElementById("p-bol").innerText = r.boleta;
    document.getElementById("p-inv").innerText = r.inventario;
    document.getElementById("p-img").src = r.foto;
  }

  function render() {
    const t = document.getElementById("res");
    t.innerHTML = "";
    db.slice().reverse().forEach((r, i) => {
      t.innerHTML += `<tr><td>${r.fecha}</td><td>${r.placa}</td>
      <td><button onclick="ver(${db.length-1-i})" style="background:#b300ff; color:white; border:none; padding:5px; border-radius:5px;">PDF</button>
      <button onclick="del(${db.length-1-i})" style="background:red; color:white; border:none; padding:5px; border-radius:5px;">X</button></td></tr>`;
    });
  }

  function ver(i) { prepPrint(db[i]); window.print(); }
  function del(i) { if(confirm("¬øBorrar?")) { db.splice(i,1); localStorage.setItem("DATA_CONS_2026", JSON.stringify(db)); render(); } }

  function excel() {
    const ws = XLSX.utils.json_to_sheet(db.map(item => { const {foto, ...r} = item; return r; }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Consignaciones");
    XLSX.writeFile(wb, "Reporte_PMT_2026.xlsx");
  }
</script>
</body>
</html>
