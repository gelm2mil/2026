<!DOCTYPE html>
<html lang="es">
<head>
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#00eaff">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AGENDA 2026 — PMT Chimaltenango</title>

  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <!-- ⚠️ TU CSS ORIGINAL SE MANTIENE INTACTO ⚠️ -->
  <!-- (no lo repito aquí para no alargar, es el mismo que enviaste) -->
</head>

<body>
<div class="agenda-shell">
  <div class="agenda-panel">

    <!-- HEADER -->
    <!-- (idéntico al tuyo, sin cambios) -->

    <!-- RESUMEN -->
    <!-- (idéntico) -->

    <!-- FORMULARIO -->
    <!-- (idéntico) -->

    <!-- TABLA -->
    <!-- (idéntico) -->

    <footer class="agenda-footer">
      2026 | <strong>BY GELM</strong> | Unidad de Transportes PMT — Chimaltenango<br>
      <span id="fechaActual"></span>
    </footer>
  </div>
</div>

<script>
/* ============================
   AGENDA 2026 — MOTOR ESTABLE
   ============================ */

const STORAGE_KEY = "agenda_2026_gelm";

/* ELEMENTOS */
const fechaInput = document.getElementById("fecha");
const categoriaSel = document.getElementById("categoria");
const servicioSel = document.getElementById("servicio");
const lugarInput = document.getElementById("lugar");
const detalleTxt = document.getElementById("detalle");

const filtroMes = document.getElementById("filtroMes");
const tbodyAgenda = document.getElementById("tbodyAgenda");
const estadoVacio = document.getElementById("estadoVacio");

const resumenVisible = document.getElementById("resumenVisible");
const resumenTotal = document.getElementById("resumenTotal");
const resumenMes = document.getElementById("resumenMes");
const ultimaActualizacion = document.getElementById("ultimaActualizacion");
const fechaActualLbl = document.getElementById("fechaActual");

const btnAgregar = document.getElementById("btnAgregar");
const btnExcel = document.getElementById("btnExcel");
const btnBorrarTodo = document.getElementById("btnBorrarTodo");

let actividades = [];

/* ============================
   UTILIDADES
   ============================ */

function hoyISO() {
  const d = new Date();
  return d.toISOString().split("T")[0];
}

function formatearFecha(fecha) {
  const [y, m, d] = fecha.split("-");
  return `${d}/${m}/${y}`;
}

function mesNumero(fecha) {
  return parseInt(fecha.split("-")[1], 10);
}

function nombreMes(num) {
  return ["Todos","Enero","Febrero","Marzo","Abril","Mayo","Junio",
          "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"][num];
}

/* ============================
   STORAGE
   ============================ */

function cargar() {
  try {
    actividades = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
  } catch {
    actividades = [];
  }
}

function guardar() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(actividades));
  actualizarFechaModificacion();
}

/* ============================
   RENDER
   ============================ */

function render() {
  tbodyAgenda.innerHTML = "";
  const mesSel = parseInt(filtroMes.value, 10);

  const visibles = actividades.filter(a =>
    mesSel === 0 || mesNumero(a.fecha) === mesSel
  );

  resumenTotal.textContent = actividades.length;
  resumenVisible.textContent = visibles.length;
  resumenMes.textContent = nombreMes(mesSel);

  if (visibles.length === 0) {
    estadoVacio.style.display = "block";
    return;
  }

  estadoVacio.style.display = "none";

  visibles.sort((a,b)=>a.fecha.localeCompare(b.fecha))
    .forEach(a => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${formatearFecha(a.fecha)}</td>
        <td>${a.categoria}</td>
        <td>${a.servicio || "-"}</td>
        <td>${a.lugar || "-"}</td>
        <td>${a.detalle}</td>`;
      tbodyAgenda.appendChild(tr);
    });
}

/* ============================
   ACCIONES
   ============================ */

function agregar() {
  if (!fechaInput.value || !detalleTxt.value) {
    alert("Completa al menos fecha y detalle.");
    return;
  }

  actividades.push({
    fecha: fechaInput.value,
    categoria: categoriaSel.value,
    servicio: servicioSel.value,
    lugar: lugarInput.value.trim(),
    detalle: detalleTxt.value.trim()
  });

  detalleTxt.value = "";
  guardar();
  render();
}

function borrarTodo() {
  if (!confirm("¿Borrar toda la agenda 2026?")) return;
  actividades = [];
  guardar();
  render();
}

function exportarExcel() {
  if (actividades.length === 0) return alert("No hay datos.");

  const data = actividades.map(a => ({
    Fecha: formatearFecha(a.fecha),
    Categoría: a.categoria,
    Servicio: a.servicio,
    Lugar: a.lugar,
    Detalle: a.detalle
  }));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(data);
  XLSX.utils.book_append_sheet(wb, ws, "Agenda 2026");
  XLSX.writeFile(wb, "Agenda_2026_PMT.xlsx");
}

/* ============================
   FECHAS
   ============================ */

function actualizarFechaModificacion() {
  ultimaActualizacion.textContent =
    "Última actualización: " +
    new Date().toLocaleString("es-GT");
}

function footerFecha() {
  fechaActualLbl.textContent =
    "Fecha actual: " +
    new Date().toLocaleDateString("es-GT", {
      day:"2-digit", month:"long", year:"numeric"
    });
}

/* ============================
   INIT
   ============================ */

btnAgregar.onclick = agregar;
btnBorrarTodo.onclick = borrarTodo;
btnExcel.onclick = exportarExcel;
filtroMes.onchange = render;

fechaInput.value = hoyISO();
cargar();
render();
footerFecha();
</script>
</body>
</html>
