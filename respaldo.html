<!DOCTYPE html>
<html lang="es">
<head>
  <!-- PWA -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#00eaff">
  <script>
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }
  </script>

  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Respaldos — Sistema PMT 2026</title>

  <link rel="stylesheet" href="styles.css">

  <style>
    body{margin:0;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;background:radial-gradient(circle at 0 0,#28d7ff 0,#150027 45%,#050109 100%);color:#e8f9ff;}
    .app-shell{min-height:100vh;display:flex;flex-direction:column;align-items:center;padding:20px 10px 40px;}
    .panel{width:100%;max-width:1100px;background:radial-gradient(circle at 10% 0,#072833 0,#050812 45%,#05010f 100%);border-radius:28px;box-shadow:0 0 40px rgba(0,255,191,.35);border:2px solid rgba(0,255,191,.3);padding:22px;}
    .panel-header{display:flex;align-items:center;justify-content:space-between;gap:20px;margin-bottom:18px;}
    .logo-box{width:100px;height:100px;border-radius:26px;background:radial-gradient(circle at 30% 0,#00ffc3 0,#001810 45%,#000 100%);box-shadow:0 0 25px rgba(0,255,191,.7);display:flex;align-items:center;justify-content:center;}
    .logo-box img{width:80%;height:80%;object-fit:contain;filter:drop-shadow(0 0 10px #00ffc3);}
    .title-block{text-align:center;flex:1;}
    .title-block h1{margin:0;font-size:24px;letter-spacing:.15em;color:#9bffe9;text-shadow:0 0 12px #00ffc3;}
    .title-block .sub1{margin-top:8px;font-size:13px;color:#d0fff5;}
    .title-block .by{margin-top:6px;font-size:11px;letter-spacing:.25em;color:#9bf7ff;text-transform:uppercase;}
    .tabs{display:flex;justify-content:center;gap:10px;margin-top:14px;flex-wrap:wrap;}
    .tab-btn{border:none;border-radius:999px;padding:9px 20px;font-size:13px;cursor:pointer;color:#e9f9ff;background:radial-gradient(circle at 0 0,#193f3a 0,#050816 60%);box-shadow:0 0 10px rgba(0,0,0,.7);border:1px solid rgba(0,255,191,.4);transition:transform .15s,box-shadow .15s,background .15s;}
    .tab-btn:hover{box-shadow:0 0 16px rgba(0,255,191,.8);transform:translateY(-1px);}
    .tab-btn.active{background:linear-gradient(135deg,#00ffc3,#00b0ff);box-shadow:0 0 20px rgba(0,255,191,.95);color:#001612;font-weight:600;}

    .section-box{margin-top:14px;background:radial-gradient(circle at 0 0,#021916 0,#02030a 70%);border-radius:22px;border:1px solid rgba(0,255,191,.35);box-shadow:0 0 25px rgba(0,255,191,.2);padding:16px 16px 20px;}
    .section-title{font-size:15px;margin:0 0 10px;color:#a4ffe9;}
    .section-desc{font-size:12px;color:#c4fff1;margin-bottom:10px;}

    .stats-grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:12px;margin-top:4px;}
    @media(max-width:800px){.panel{padding:16px}.panel-header{flex-direction:column}.stats-grid{grid-template-columns:1fr}}
    .stat-box{background:rgba(0,0,0,.4);border-radius:16px;padding:10px 12px;border:1px solid rgba(0,255,191,.4);box-shadow:0 0 18px rgba(0,255,191,.2);}
    .stat-title{font-size:12px;color:#9fffe1;margin-bottom:4px;}
    .stat-value{font-size:20px;font-weight:700;color:#eaffe9;text-shadow:0 0 10px rgba(0,255,191,.8);}
    .stat-sub{font-size:11px;color:#c7fff1;margin-top:3px;}

    .actions-row{margin-top:10px;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .btn{border:none;border-radius:999px;padding:9px 18px;font-size:12px;cursor:pointer;font-weight:600;letter-spacing:.03em;text-transform:uppercase;transition:transform .15s,box-shadow .15s,filter .15s;white-space:nowrap;}
    .btn-primary{background:linear-gradient(135deg,#00ffc3,#00b3ff);color:#001612;box-shadow:0 0 18px rgba(0,255,191,.95);}
    .btn-secondary{background:linear-gradient(135deg,#fff07b,#7bffb9);color:#15300b;box-shadow:0 0 14px rgba(255,240,120,.8);}
    .btn-danger{background:linear-gradient(135deg,#ff4b4b,#ff0044);color:#fff4f4;box-shadow:0 0 16px rgba(255,0,80,.9);}
    .btn:hover{filter:brightness(1.06);transform:translateY(-1px);box-shadow:0 0 24px rgba(0,255,191,1);}

    .range-row{margin-top:8px;font-size:12px;color:#c4fff1;display:flex;flex-wrap:wrap;gap:10px;align-items:center;}
    .select-range{background:#021b18;color:#eaffe9;border-radius:999px;border:1px solid #00ffc366;padding:7px 11px;font-size:12px;outline:none;box-shadow:0 0 10px rgba(0,255,191,.25);}

    .file-input{margin-top:8px;font-size:12px;color:#c4fff1;background:#021b18;border-radius:14px;padding:8px 10px;border:1px dashed #00ffc3;}
    footer{margin-top:14px;text-align:center;font-size:11px;color:#c4fff1;}
    footer span.brand{color:#00ffc3;font-weight:600;}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
<div class="app-shell">
  <div class="panel">
    <header class="panel-header">
      <div class="logo-box">
        <img src="icons/icon-192.png" alt="GELM">
      </div>

      <div class="title-block">
        <h1>RESPALDOS — SISTEMA PMT 2026</h1>
        <div class="sub1">Centro de backups y exportación global (Agenda + Operativos + Denuncias)</div>
        <div class="by">== BY GELM ==</div>

        <div class="tabs">
          <button class="tab-btn" onclick="location.href='agen2026.html'">Agenda 2026</button>
          <button class="tab-btn" onclick="location.href='operativos.html'">Operativos</button>
          <button class="tab-btn" onclick="location.href='denuncias.html'">Denuncias</button>
          <button class="tab-btn" onclick="location.href='https://gelm2mil.github.io/gelm/'">Buscar</button>
          <button class="tab-btn active">Respaldos</button>
        </div>
      </div>

      <div class="logo-box">
        <img src="icons/icon-192.png" alt="GELM">
      </div>
    </header>

    <!-- STATS -->
    <section class="section-box">
      <h2 class="section-title">Resumen de datos almacenados</h2>
      <p class="section-desc">
        Aquí puedes ver cuántos registros tienes guardados en el teléfono y exportarlos para tus informes semanales o mensuales.
      </p>

      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-title">Agenda 2026</div>
          <div class="stat-value" id="count-agenda">0</div>
          <div class="stat-sub">Actividades registradas</div>
        </div>
        <div class="stat-box">
          <div class="stat-title">Operativos 2026</div>
          <div class="stat-value" id="count-operativos">0</div>
          <div class="stat-sub">Operativos registrados</div>
        </div>
        <div class="stat-box">
          <div class="stat-title">Denuncias 2026</div>
          <div class="stat-value" id="count-denuncias">0</div>
          <div class="stat-sub">Denuncias registradas</div>
        </div>
      </div>
    </section>

    <!-- EXPORT -->
    <section class="section-box">
      <h2 class="section-title">Exportar a Excel</h2>
      <p class="section-desc">
        Genera un archivo Excel con hojas separadas para <strong>Agenda, Operativos y Denuncias</strong>.
        Ideal para entregar informes por semana o por mes.
      </p>

      <div class="range-row">
        Rango a exportar:
        <select id="rango" class="select-range">
          <option value="todo">Todo 2026</option>
          <option value="mes">Solo mes actual</option>
          <option value="semana">Solo semana actual</option>
        </select>
      </div>

      <div class="actions-row" style="margin-top:10px">
        <button class="btn btn-primary" id="btn-excel-global">Descargar Excel global</button>
      </div>
    </section>

    <!-- JSON -->
    <section class="section-box">
      <h2 class="section-title">Respaldos JSON (para restaurar en el futuro)</h2>
      <p class="section-desc">
        Guarda un archivo <strong>.json</strong> con toda la información del sistema.  
        Más adelante puedes restaurarlo en otro teléfono o después de borrar datos.
      </p>

      <div class="actions-row">
        <button class="btn btn-secondary" id="btn-descargar-json">Descargar respaldo JSON</button>
      </div>

      <div class="file-input">
        <strong>Cargar respaldo JSON:</strong><br>
        <input id="file-json" type="file" accept="application/json">
        <div style="font-size:11px;margin-top:4px;opacity:.85">
          Al cargar un respaldo se reemplazarán los datos actuales de Agenda, Operativos y Denuncias.<br>
          Se recomienda hacer primero un respaldo antes de restaurar.
        </div>
      </div>

      <div class="actions-row" style="margin-top:10px">
        <button class="btn btn-danger" id="btn-restaurar-json">Restaurar desde archivo</button>
      </div>
    </section>

    <footer>
      2026 | <span class="brand">BY GELM</span> | Unidad de Transportes PMT — Chimaltenango
    </footer>
  </div>
</div>

<script>
  const KEY_AGENDA = 'agenda2026';
  const KEY_OPERATIVOS = 'operativos2026';
  const KEY_DENUNCIAS = 'denuncias2026';

  function getData() {
    const agenda = JSON.parse(localStorage.getItem(KEY_AGENDA) || '[]');
    const operativos = JSON.parse(localStorage.getItem(KEY_OPERATIVOS) || '[]');
    const denuncias = JSON.parse(localStorage.getItem(KEY_DENUNCIAS) || '[]');
    return { agenda, operativos, denuncias };
  }

  function actualizarStats() {
    const { agenda, operativos, denuncias } = getData();
    document.getElementById('count-agenda').textContent = agenda.length;
    document.getElementById('count-operativos').textContent = operativos.length;
    document.getElementById('count-denuncias').textContent = denuncias.length;
  }

  function parseFechaDDMMYYYY(fechaStr) {
    if (!fechaStr) return null;
    const parts = fechaStr.split('/');
    if (parts.length !== 3) return null;
    const [d, m, y] = parts.map(Number);
    if (!d || !m || !y) return null;
    return new Date(y, m - 1, d);
  }

  function dentroDeRango(fecha, rango) {
    if (!fecha) return false;
    const f = fecha;
    const hoy = new Date();

    if (rango === 'todo') return true;

    if (rango === 'mes') {
      return f.getFullYear() === hoy.getFullYear() && f.getMonth() === hoy.getMonth();
    }

    if (rango === 'semana') {
      const diaSemana = hoy.getDay() || 7; // 1-7 (lunes-domingo)
      const inicio = new Date(hoy);
      inicio.setDate(hoy.getDate() - (diaSemana - 1));
      inicio.setHours(0,0,0,0);
      const fin = new Date(inicio);
      fin.setDate(inicio.getDate() + 6);
      fin.setHours(23,59,59,999);
      return f >= inicio && f <= fin;
    }
    return true;
  }

  document.getElementById('btn-excel-global').addEventListener('click', () => {
    const { agenda, operativos, denuncias } = getData();
    const rango = document.getElementById('rango').value;

    if (agenda.length === 0 && operativos.length === 0 && denuncias.length === 0) {
      alert('No hay datos para exportar.');
      return;
    }

    const wb = XLSX.utils.book_new();

    // AGENDA
    if (agenda.length) {
      const agendaFiltrada = agenda.filter(item => {
        // se asume que la agenda guarda la fecha como "dd/mm/aaaa" en item.fecha
        const f = parseFechaDDMMYYYY(item.fecha);
        return !f || dentroDeRango(f, rango);
      });

      const wsAgenda = XLSX.utils.json_to_sheet(agendaFiltrada);
      XLSX.utils.book_append_sheet(wb, wsAgenda, 'Agenda 2026');
    }

    // OPERATIVOS
    if (operativos.length) {
      const operFiltrados = operativos.filter(op => {
        const f = op.fecha ? new Date(op.fecha) : null;
        return !f || dentroDeRango(f, rango);
      });

      const dataOper = operFiltrados.map(op => ({
        'Fecha': op.fecha ? new Date(op.fecha).toLocaleDateString('es-GT') : '',
        'Hora inicio': op.horaInicio || '',
        'Hora fin': op.horaFin || '',
        'Tipo operativo': op.tipoOperativo || '',
        'Lugar / ruta': op.lugarRuta || '',
        'Licencias consignadas': op.licenciasConsignadas ?? 0,
        'Vehículos consignados': op.vehiculosConsignados ?? 0,
        'Personal asignado': op.personalAsignado || '',
        'Detalle': op.detalle || '',
        'Variación': op.variacion || '',
        'Observaciones': op.observaciones || ''
      }));
      const wsOper = XLSX.utils.json_to_sheet(dataOper);
      XLSX.utils.book_append_sheet(wb, wsOper, 'Operativos 2026');
    }

    // DENUNCIAS
    if (denuncias.length) {
      const denFiltradas = denuncias.filter(d => {
        const f = d.fecha ? new Date(d.fecha) : null;
        return !f || dentroDeRango(f, rango);
      });

      const dataDen = denFiltradas.map(d => ({
        'Fecha': d.fecha ? new Date(d.fecha).toLocaleDateString('es-GT') : '',
        'Hora': d.hora || '',
        'Identificador (Placa/DPI)': d.identificador || '',
        'Tipo denuncia': d.tipoDenuncia || '',
        'Lugar': d.lugar || '',
        'Estado': d.estado || '',
        'Descripción': d.descripcion || '',
        'Observaciones internas': d.observaciones || '',
        'Tiene imagen': d.imagen ? 'Sí' : 'No'
      }));
      const wsDen = XLSX.utils.json_to_sheet(dataDen);
      XLSX.utils.book_append_sheet(wb, wsDen, 'Denuncias 2026');
    }

    const nombre = `resumen_pmt2026_${rango}_${new Date().toISOString().slice(0,10)}.xlsx`;
    XLSX.writeFile(wb, nombre);
  });

  document.getElementById('btn-descargar-json').addEventListener('click', () => {
    const data = getData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `respaldo_pmt2026_${new Date().toISOString().slice(0,10)}.json`;
    a.click();
    URL.revokeObjectURL(url);
  });

  document.getElementById('btn-restaurar-json').addEventListener('click', () => {
    const input = document.getElementById('file-json');
    const file = input.files[0];
    if (!file) {
      alert('Selecciona primero un archivo JSON de respaldo.');
      return;
    }
    if (!confirm('Se reemplazarán los datos actuales por los del archivo. ¿Continuar?')) return;

    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const obj = JSON.parse(e.target.result);
        if (!obj || typeof obj !== 'object') throw new Error('Formato inválido');

        if (obj.agenda)      localStorage.setItem(KEY_AGENDA, JSON.stringify(obj.agenda));
        if (obj.operativos)  localStorage.setItem(KEY_OPERATIVOS, JSON.stringify(obj.operativos));
        if (obj.denuncias)   localStorage.setItem(KEY_DENUNCIAS, JSON.stringify(obj.denuncias));

        alert('Respaldo restaurado correctamente.');
        actualizarStats();
      } catch (err) {
        alert('El archivo no parece ser un respaldo válido.');
      }
    };
    reader.readAsText(file);
  });

  actualizarStats();
</script>
</body>
</html>
