<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Hechos de Tránsito — GELM SYSTEM 2026</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body{margin:0;font-family:system-ui;background:radial-gradient(circle at top,#24002b,#060012);color:#e9f9ff}
.shell{max-width:1280px;margin:10px auto;padding:12px}
.panel{background:rgba(3,5,20,.96);border-radius:24px;padding:16px;box-shadow:0 0 30px rgba(0,234,255,.35)}
h1{text-align:center;color:#00ffc8;margin:0}
.sub{text-align:center;font-size:.8rem;color:#9cb3d8}
.by{text-align:center;color:#00eaff;letter-spacing:.15em;font-size:.7rem}
.card{background:#020616;border-radius:18px;padding:14px;margin:12px 0}
.grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
@media (max-width:600px){.grid{grid-template-columns:1fr}}
label{font-size:.7rem;color:#9cb3d8;text-transform:uppercase}
input,select,textarea{width:100%;padding:12px;border-radius:14px;border:1px solid #00eaff;background:#020616;color:#fff}
textarea{min-height:90px}
.firmas-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width:480px){.firmas-grid{grid-template-columns:1fr}}
.firma-box{width:100%;aspect-ratio:3/1.6;background:#fff;border-radius:14px;border:2px dashed #00ffc8}
.firma-box canvas{width:100%;height:100%;touch-action:none}
.actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between}
button{border-radius:999px;padding:10px 22px;border:none;cursor:pointer;font-weight:700;background:linear-gradient(135deg,#00eaff,#00ffc8,#b300ff);color:#020510}
.danger{background:linear-gradient(135deg,#ff0044,#ff7a3c);color:#fff}
.fotos-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.fotos-grid img{width:100%;border-radius:10px}
table{width:100%;border-collapse:collapse;font-size:.8rem}
thead{background:linear-gradient(90deg,#00ffc8,#00eaff);color:#020510}
th,td{padding:8px;border-bottom:1px solid #333}
tbody tr:nth-child(even){background:rgba(0,255,200,.05)}
footer{text-align:center;font-size:.75rem;color:#9cb3d8;margin-top:14px}
</style>
</head>
<body>
<div class="shell"><div class="panel">
<h1>HECHOS DE TRÁNSITO</h1>
<div class="sub">GELM-SYSTEM-2026 — PMT Chimaltenango</div>
<div class="by">== SISTEMA OFICIAL ==</div>

<div class="card">
<div class="grid">
  <div><label>Fecha</label><input type="date" id="fecha"></div>
  <div><label>Hora</label><input type="time" id="hora"></div>
  <div><label>Tipo</label>
    <select id="tipo">
      <option>Colisión Simple</option>
      <option>Colisión Múltiple</option>
      <option>Atropello</option>
      <option>Daños Materiales</option>
    </select>
  </div>
</div>
<label>Dirección</label>
<input id="direccion">
</div>

<div class="card">
<h3>Vehículo A</h3>
<div class="grid">
  <input id="a_placa" placeholder="Placa">
  <input id="a_tipo" placeholder="Tipo">
  <input id="a_marca" placeholder="Marca">
  <input id="a_color" placeholder="Color">
</div>
<h4>Conductor A</h4>
<div class="grid">
  <input id="a_nombre" placeholder="Nombre completo">
  <select id="a_lic_tipo"><option>A</option><option>B</option><option>C</option><option>M</option><option>E</option><option>NO POSEE</option></select>
  <input id="a_licencia" placeholder="Licencia">
  <input id="a_documento" placeholder="Documento">
</div>
</div>

<div class="card">
<h3>Vehículo B</h3>
<div class="grid">
  <input id="b_placa" placeholder="Placa">
  <input id="b_tipo" placeholder="Tipo">
  <input id="b_marca" placeholder="Marca">
  <input id="b_color" placeholder="Color">
</div>
<h4>Conductor B</h4>
<div class="grid">
  <input id="b_nombre" placeholder="Nombre completo">
  <select id="b_lic_tipo"><option>A</option><option>B</option><option>C</option><option>M</option><option>E</option><option>NO POSEE</option></select>
  <input id="b_licencia" placeholder="Licencia">
  <input id="b_documento" placeholder="Documento">
</div>
</div>

<div class="card">
<h3>Agente PMT</h3>
<div class="grid">
  <input id="agente_nombre" placeholder="Nombre del Agente">
  <input id="agente_chapa" placeholder="Chapa">
</div>
</div>

<div class="card">
<h3>Nota / Acuerdo</h3>
<textarea id="nota"></textarea>
</div>

<div class="card">
<h3>Fotos del Hecho</h3>
<input type="file" id="fotos" accept="image/*" multiple capture="environment">
<div id="preview" class="fotos-grid"></div>
</div>

<div class="card">
<h3>Firmas</h3>
<div class="firmas-grid">
  <div class="firma-box"><canvas id="sigA"></canvas></div>
  <div class="firma-box"><canvas id="sigB"></canvas></div>
</div>
</div>

<div class="actions">
  <button onclick="guardar()">Guardar</button>
  <button onclick="exportarPDF()">PDF</button>
  <button onclick="exportarWord()">Word</button>
  <button onclick="exportarExcel()">Excel</button>
  <button onclick="nuevo()">Nuevo</button>
  <button class="danger" onclick="borrar()">Borrar todo</button>
</div>

<div class="card">
<table><thead><tr><th>Fecha</th><th>Hora</th><th>Tipo</th><th>Placa A</th><th>Placa B</th></tr></thead>
<tbody id="tabla"></tbody></table>
</div>

<footer>© 2026 — GELM SYSTEM — PMT</footer>
</div></div>

<script>
const KEY = "GELM:HECHOS:2026:PMT";
const SHEETS_URL = "https://script.google.com/macros/s/AKfycby25jzx7NawMQy72xe0CoR4yBxsiQCiZAlk_kICGLSUc_O71u-vfJUT0499nXujQ4OMMA/exec";

let db = JSON.parse(localStorage.getItem(KEY) || "[]");
let fotosData = [];
let sigAData = null;
let sigBData = null;
let guardadoEnSesion = false;

function fitCanvas(c){
  const rect = c.getBoundingClientRect();
  const k = window.devicePixelRatio || 1;
  const ctx = c.getContext('2d');
  c.width = rect.width * k;
  c.height = rect.height * k;
  ctx.setTransform(k,0,0,k,0,0);
  ctx.lineWidth = 2; ctx.lineCap = 'round';
}

fitCanvas(sigA); fitCanvas(sigB);

function hookFirma(canvas, which){
  const ctx = canvas.getContext('2d');
  let d=false;
  canvas.addEventListener('pointerdown', e=>{ d=true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); });
  canvas.addEventListener('pointermove', e=>{
    if(!d) return;
    ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke();
    if(which==='A') sigAData = canvas.toDataURL();
    if(which==='B') sigBData = canvas.toDataURL();
  });
  window.addEventListener('pointerup', ()=>{ d=false; });
}

hookFirma(sigA,'A'); hookFirma(sigB,'B');

fotos.onchange = () => {
  [...fotos.files].forEach(f=>{
    const r = new FileReader();
    r.onload = e=>{
      fotosData.push(e.target.result);
      const img = document.createElement('img');
      img.src = e.target.result;
      preview.appendChild(img);
    };
    r.readAsDataURL(f);
  });
};

function guardarSilencioso(){
  if(sigA) sigAData = sigA.toDataURL();
  if(sigB) sigBData = sigB.toDataURL();
  const r={
    fecha:fecha.value,hora:hora.value,tipo:tipo.value,direccion:direccion.value,
    a:{placa:a_placa.value,tipo:a_tipo.value,marca:a_marca.value,color:a_color.value,nombre:a_nombre.value,lic_tipo:a_lic_tipo.value,licencia:a_licencia.value,documento:a_documento.value},
    b:{placa:b_placa.value,tipo:b_tipo.value,marca:b_marca.value,color:b_color.value,nombre:b_nombre.value,lic_tipo:b_lic_tipo.value,licencia:b_licencia.value,documento:b_documento.value},
    agente:{nombre:agente_nombre.value,chapa:agente_chapa.value},
    nota:nota.value,fotos:fotosData,firmaA:sigAData,firmaB:sigBData
  };
  db.push(r);
  localStorage.setItem(KEY, JSON.stringify(db));
  render();
  fetch(SHEETS_URL,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:'data='+encodeURIComponent(JSON.stringify(r))}).catch(()=>{});
  guardadoEnSesion = true;
}

function guardar(){ if(!fecha.value || !a_placa.value) return; guardarSilencioso(); }

function render(){ tabla.innerHTML = db.map(x=>`<tr><td>${x.fecha}</td><td>${x.hora||''}</td><td>${x.tipo}</td><td>${x.a.placa}</td><td>${x.b.placa}</td></tr>`).join(''); }
render();

function asegurarGuardado(){ if(!guardadoEnSesion){ if(!fecha.value) throw new Error('No data'); guardarSilencioso(); } }

function downloadBlob(url, name){ const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); }

function exportarPDF(){
  asegurarGuardado();
  const {jsPDF}=window.jspdf;
  const r=db.at(-1);
  const d=new jsPDF(); let y=20;
  const line=(t)=>{ d.text(t,20,y); y+=7; if(y>270){ d.addPage(); y=20; } };
  d.text('HECHOS DE TRÁNSITO — GELM 2026',105,12,{align:'center'});
  line(`Fecha: ${r.fecha}   Hora: ${r.hora}`);
  line(`Tipo: ${r.tipo}`);
  line(`Dirección: ${r.direccion}`); y+=5;
  line('Vehículo A:');
  line(`  Placa: ${r.a.placa}  Tipo: ${r.a.tipo}  Marca: ${r.a.marca}  Color: ${r.a.color}`);
  line(`  Conductor: ${r.a.nombre}  Lic: ${r.a.lic_tipo} ${r.a.licencia}  Doc: ${r.a.documento}`); y+=5;
  line('Vehículo B:');
  line(`  Placa: ${r.b.placa}  Tipo: ${r.b.tipo}  Marca: ${r.b.marca}  Color: ${r.b.color}`);
  line(`  Conductor: ${r.b.nombre}  Lic: ${r.b.lic_tipo} ${r.b.licencia}  Doc: ${r.b.documento}`); y+=5;
  line(`Agente PMT: ${r.agente.nombre}  Chapa: ${r.agente.chapa}`); y+=5;
  line('Nota / Acuerdo:');
  (r.nota||'').split('\n').forEach(t=>line('  '+t));
  if(r.fotos && r.fotos.length){
    d.addPage(); y=20;
    r.fotos.forEach(img=>{ if(y>230){ d.addPage(); y=20; } d.addImage(img,'JPEG',20,y,80,50); y+=55; });
  }
  d.addPage(); d.text('FIRMAS',105,20,{align:'center'});
  if(r.firmaA) d.addImage(r.firmaA,'PNG',20,60,70,30);
  if(r.firmaB) d.addImage(r.firmaB,'PNG',120,60,70,30);
  const url = d.output('bloburl');
  downloadBlob(url, 'HECHOS_GELM_2026.pdf');
}

function exportarWord(){
  asegurarGuardado();
  const r=db.at(-1);
  const t=`HECHOS DE TRÁNSITO — GELM 2026\n\nFecha: ${r.fecha}\nHora: ${r.hora}\nTipo: ${r.tipo}\nDirección: ${r.direccion}\n\nVEHÍCULO A\nPlaca: ${r.a.placa}\nTipo: ${r.a.tipo}\nMarca: ${r.a.marca}\nColor: ${r.a.color}\nConductor: ${r.a.nombre}\nLicencia: ${r.a.lic_tipo} ${r.a.licencia}\nDocumento: ${r.a.documento}\n\nVEHÍCULO B\nPlaca: ${r.b.placa}\nTipo: ${r.b.tipo}\nMarca: ${r.b.marca}\nColor: ${r.b.color}\nConductor: ${r.b.nombre}\nLicencia: ${r.b.lic_tipo} ${r.b.licencia}\nDocumento: ${r.b.documento}\n\nAGENTE PMT\n${r.agente.nombre} — Chapa ${r.agente.chapa}\n\nNOTA / ACUERDO\n${r.nota||''}`;
  const b=new Blob([t],{type:'application/msword'});
  const url=URL.createObjectURL(b);
  downloadBlob(url, 'HECHOS_GELM_2026.doc');
}

function exportarExcel(){
  asegurarGuardado();
  const ws=XLSX.utils.json_to_sheet(db.map(r=>({fecha:r.fecha,hora:r.hora,tipo:r.tipo,direccion:r.direccion,placaA:r.a.placa,conductorA:r.a.nombre,placaB:r.b.placa,conductorB:r.b.nombre,agente:r.agente.nombre,chapa:r.agente.chapa,nota:r.nota})));
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Hechos');
  const out = XLSX.write(wb,{bookType:'xlsx',type:'array'});
  const url = URL.createObjectURL(new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}));
  downloadBlob(url, 'HECHOS_GELM_2026.xlsx');
}

function nuevo(){
  document.querySelectorAll('input, textarea').forEach(i=>i.value='');
  tipo.selectedIndex=0; fotosData=[]; preview.innerHTML='';
  sigAData=null; sigBData=null; guardadoEnSesion=false;
  sigA.getContext('2d').clearRect(0,0,sigA.width,sigA.height);
  sigB.getContext('2d').clearRect(0,0,sigB.width,sigB.height);
}

function borrar(){ if(confirm('¿BORRAR TODO?')){ db=[]; localStorage.removeItem(KEY); render(); } }
</script>
</body>
</html>
