<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CONSIGNACIONES 2026 — PMT Chimaltenango</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
--c1:#00eaff;--c2:#00ffc8;--bg:#020510;--card:#05071d;--txt:#e9f9ff;--danger:#ff0044;
}
body{margin:0;font-family:Segoe UI;background:var(--bg);color:var(--txt);display:flex;justify-content:center;padding:10px}
.container{width:100%;max-width:900px}
.panel{background:var(--card);border-radius:25px;padding:20px;border:1px solid rgba(0,234,255,.3)}
h1{text-align:center;color:var(--c2)}
.section{background:rgba(255,255,255,.04);padding:15px;border-radius:15px;margin-bottom:15px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}
label{font-size:.7rem;color:#9cb3d8}
input,textarea{width:100%;padding:8px;border-radius:8px;background:#000;border:1px solid var(--c1);color:#fff}
canvas{background:#fff;width:100%;height:120px;border-radius:8px;touch-action:none}
button{cursor:pointer}
.btn{padding:12px;border-radius:30px;border:none;font-weight:bold}
.btn-save{background:linear-gradient(90deg,var(--c1),var(--c2));color:#000}
.btn-pdf{background:#8a00ff;color:#fff}
.btn-excel{background:#28a745;color:#fff;width:100%}
.btn-clear{background:var(--danger);color:#fff;border:none;padding:4px 8px;border-radius:5px;font-size:10px}
table{width:100%;border-collapse:collapse;font-size:.8rem}
th{background:var(--c1);color:#000;padding:6px}
td{padding:6px;border-bottom:1px solid rgba(0,234,255,.2)}
.btn-del{background:transparent;border:1px solid var(--danger);color:var(--danger);border-radius:5px}
#preview{max-width:150px;border:1px solid var(--c1);border-radius:10px;display:none;margin:auto}
</style>
</head>

<body>
<div class="container">
<div class="panel">
<h1>Boleta de Consignación 2026</h1>

<div class="section grid">
<div><label>Fecha</label><input type="date" id="fecha"></div>
<div><label>Hora</label><input type="time" id="hora"></div>
</div>

<div class="section">
<div class="grid">
<div style="grid-column:span 2"><label>Conductor</label><input id="c_nombre"></div>
<div><label>Licencia</label><input id="c_licencia"></div>
<div><label>DPI</label><input id="c_dpi"></div>
</div>
</div>

<div class="section">
<div class="grid">
<div><label>Placa</label><input id="v_placa"></div>
<div><label>Marca</label><input id="v_marca"></div>
<div><label>Color</label><input id="v_color"></div>
<div><label>NIT</label><input id="v_nit"></div>
</div>
</div>

<div class="section">
<input type="file" accept="image/*" capture="camera" onchange="previewFoto(event)">
<img id="preview">
<label>Motivo</label><textarea id="h_motivo"></textarea>
<label>Observaciones</label><textarea id="h_obs"></textarea>
</div>

<div class="section grid">
<div>
<canvas id="canvasAgente"></canvas>
<button class="btn-clear" onclick="limpiar('canvasAgente')">Borrar Firma</button>
</div>
<div>
<canvas id="canvasConductor"></canvas>
<button class="btn-clear" onclick="limpiar('canvasConductor')">Borrar Firma</button>
</div>
</div>

<div class="grid">
<button class="btn btn-save" onclick="guardar()">Guardar</button>
<button class="btn btn-pdf" onclick="generarPDFActual()">PDF Actual</button>
<button class="btn btn-excel" onclick="exportarExcel()">Excel</button>
</div>

<hr>

<table>
<thead><tr><th>Fecha</th><th>Placa</th><th>Conductor</th><th>PDF</th><th>X</th></tr></thead>
<tbody id="tbody"></tbody>
</table>

</div>
</div>

<script>
const KEY="PMT_CONSIG_2026";
let data=JSON.parse(localStorage.getItem(KEY))||[];
let fotoBase64="";

(function autoFecha(){
const d=new Date();
fecha.value=d.toISOString().split('T')[0];
hora.value=d.toTimeString().slice(0,5);
})();

function initCanvas(id){
const c=document.getElementById(id),x=c.getContext("2d");
c.width=c.offsetWidth;c.height=120;
let draw=false;
const pos=e=>{const r=c.getBoundingClientRect();return{
x:(e.touches?e.touches[0].clientX:e.clientX)-r.left,
y:(e.touches?e.touches[0].clientY:e.clientY)-r.top}};
c.onmousedown=e=>{draw=true;x.beginPath();p=pos(e);x.moveTo(p.x,p.y)};
c.onmousemove=e=>{if(!draw)return;p=pos(e);x.lineTo(p.x,p.y);x.stroke()};
window.onmouseup=()=>draw=false;
c.ontouchstart=e=>{draw=true;x.beginPath();p=pos(e);x.moveTo(p.x,p.y)};
c.ontouchmove=e=>{if(!draw)return;e.preventDefault();p=pos(e);x.lineTo(p.x,p.y);x.stroke()};
}
initCanvas("canvasAgente");initCanvas("canvasConductor");

function limpiar(id){
const c=document.getElementById(id);
c.getContext("2d").clearRect(0,0,c.width,c.height);
}

function previewFoto(e){
const r=new FileReader();
r.onload=()=>{fotoBase64=r.result;preview.src=fotoBase64;preview.style.display="block";}
r.readAsDataURL(e.target.files[0]);
}

function guardar(){
if(!v_placa.value) return alert("Falta placa");
const obj={
id:Date.now(),
fecha:fecha.value,hora:hora.value,
conductor:c_nombre.value,licencia:c_licencia.value,dpi:c_dpi.value,
placa:v_placa.value,marca:v_marca.value,color:v_color.value,nit:v_nit.value,
motivo:h_motivo.value,obs:h_obs.value,
foto:fotoBase64,
fAgente:canvasAgente.toDataURL(),
fConductor:canvasConductor.toDataURL()
};
data.push(obj);
localStorage.setItem(KEY,JSON.stringify(data));
location.reload();
}

function generarPDF(obj){
const {jsPDF}=window.jspdf;
const d=new jsPDF();
d.text("BOLETA OFICIAL PMT CHIMALTENANGO",105,15,{align:"center"});
d.text(`Fecha: ${obj.fecha} ${obj.hora}`,20,25);
d.text(`Conductor: ${obj.conductor}`,20,35);
d.text(`Placa: ${obj.placa}`,20,45);
d.text("Motivo:",20,55);
d.text(d.splitTextToSize(obj.motivo,170),20,60);
if(obj.foto)d.addImage(obj.foto,"JPEG",20,90,60,45);
d.addImage(obj.fAgente,"PNG",20,150,50,20);
d.addImage(obj.fConductor,"PNG",120,150,50,20);
d.save(`BOLETA_${obj.placa}.pdf`);
}

function generarPDFActual(){
const temp=data[data.length-1];
if(temp)generarPDF(temp);
}

function exportarExcel(){
const ws=XLSX.utils.json_to_sheet(data);
const wb=XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb,ws,"Consignas");
XLSX.writeFile(wb,"REPORTE_2026.xlsx");
}

function borrar(id){
if(!confirm("¿Eliminar?"))return;
data=data.filter(r=>r.id!==id);
localStorage.setItem(KEY,JSON.stringify(data));
location.reload();
}

tbody.innerHTML=data.reverse().map(r=>`
<tr>
<td>${r.fecha}</td>
<td>${r.placa}</td>
<td>${r.conductor}</td>
<td><button onclick='generarPDF(${JSON.stringify(r)})'>PDF</button></td>
<td><button class="btn-del" onclick="borrar(${r.id})">X</button></td>
</tr>`).join("");
</script>
</body>
</html>
