<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CONSIGNACIONES 2026 — PMT Chimaltenango</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --gelm-cyan: #00eaff;
            --gelm-cyan-soft: #00ffc8;
            --gelm-bg: #020510;
            --gelm-card: rgba(3, 5, 25, 0.95);
            --gelm-text: #e9f9ff;
            --gelm-danger: #ff0044;
        }

        body {
            margin: 0; font-family: 'Segoe UI', sans-serif;
            background: var(--gelm-bg); color: var(--gelm-text);
            display: flex; justify-content: center; padding: 10px;
        }

        .container { width: 100%; max-width: 900px; }

        .panel {
            background: var(--gelm-card); border-radius: 25px;
            border: 1px solid rgba(0, 234, 255, 0.3); padding: 20px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        h1 { color: var(--gelm-cyan-soft); text-align: center; text-transform: uppercase; font-size: 1.4rem; text-shadow: 0 0 10px var(--gelm-cyan); }

        .section {
            background: rgba(255,255,255,0.03); border-radius: 15px;
            padding: 15px; margin-bottom: 15px; border: 1px solid rgba(0,234,255,0.1);
        }

        .section-title { color: var(--gelm-cyan); font-size: 0.8rem; font-weight: bold; margin-bottom: 10px; text-transform: uppercase; display: flex; justify-content: space-between; align-items: center; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; }

        label { display: block; font-size: 0.7rem; color: #9cb3d8; margin-bottom: 3px; }

        input, select, textarea {
            width: 100%; padding: 8px; border-radius: 8px; background: #000;
            border: 1px solid rgba(0, 234, 255, 0.3); color: #fff; font-size: 0.9rem;
        }

        /* Foto */
        #preview { max-width: 150px; border-radius: 10px; border: 1px solid var(--gelm-cyan); display: none; margin: 10px auto; }

        /* Firmas */
        canvas { background: #fff; border-radius: 8px; width: 100%; height: 120px; touch-action: none; }
        .btn-clear { background: var(--gelm-danger); color: #fff; border: none; padding: 4px 8px; border-radius: 4px; font-size: 10px; margin-top: 5px; cursor: pointer; }

        /* Botonera */
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 20px; }
        .btn { padding: 12px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; text-transform: uppercase; font-size: 0.8rem; transition: 0.2s; }
        .btn-save { background: linear-gradient(90deg, #00eaff, #00ffc8); color: #000; }
        .btn-pdf { background: #b300ff; color: #fff; }
        .btn-excel { background: #28a745; color: #fff; grid-column: span 2; }
        .btn:active { transform: scale(0.98); }

        /* Historial */
        .history { margin-top: 20px; overflow-x: auto; font-size: 0.8rem; }
        table { width: 100%; border-collapse: collapse; }
        th { background: var(--gelm-cyan); color: #000; padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid rgba(0,234,255,0.1); }

        /* Botón de eliminar individual */
        .btn-delete-row {
            background: rgba(255, 0, 68, 0.2); color: var(--gelm-danger);
            border: 1px solid var(--gelm-danger); border-radius: 5px;
            padding: 2px 8px; cursor: pointer; font-weight: bold;
        }
        .btn-delete-row:hover { background: var(--gelm-danger); color: white; }

        /* Botón borrar todo */
        .btn-danger-soft {
            background: transparent; color: var(--gelm-danger);
            border: 1px solid var(--gelm-danger); font-size: 0.6rem;
            padding: 2px 8px; border-radius: 5px; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="panel">
        <h1>Boleta de Consignación 2026</h1>

        <form id="formConsignacion">
            <div class="section grid">
                <div><label>Fecha</label><input type="date" id="fecha"></div>
                <div><label>Hora</label><input type="time" id="hora"></div>
            </div>

            <div class="section">
                <div class="section-title">Datos del Conductor</div>
                <div class="grid">
                    <div style="grid-column: span 2;"><label>Nombres y Apellidos</label><input type="text" id="c_nombre"></div>
                    <div><label>No. Licencia</label><input type="text" id="c_licencia"></div>
                    <div><label>No. Documento (DPI)</label><input type="text" id="c_dpi"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Datos del Vehículo</div>
                <div class="grid">
                    <div><label>Placa</label><input type="text" id="v_placa"></div>
                    <div><label>Marca</label><input type="text" id="v_marca"></div>
                    <div><label>Color</label><input type="text" id="v_color"></div>
                    <div><label>NIT Propietario</label><input type="text" id="v_nit"></div>
                </div>
            </div>

            <div class="section">
                <div class="section-title">Evidencia y Motivo</div>
                <input type="file" id="fotoInput" accept="image/*" capture="camera" onchange="previewFoto(event)">
                <center><img id="preview"></center>
                
                <label>Motivo</label>
                <textarea id="h_motivo" rows="2"></textarea>
                <label>Observaciones</label>
                <textarea id="h_obs" rows="2"></textarea>
            </div>

            <div class="section">
                <div class="section-title">Firmas</div>
                <div class="grid">
                    <div>
                        <canvas id="canvasAgente"></canvas>
                        <center><button type="button" class="btn-clear" onclick="limpiar('canvasAgente')">Borrar Firma</button></center>
                    </div>
                    <div>
                        <canvas id="canvasConductor"></canvas>
                        <center><button type="button" class="btn-clear" onclick="limpiar('canvasConductor')">Borrar Firma</button></center>
                    </div>
                </div>
            </div>

            <div class="actions">
                <button type="button" class="btn btn-save" onclick="guardar()">Guardar Datos</button>
                <button type="button" class="btn btn-pdf" onclick="generarPDF()">Exportar PDF</button>
                <button type="button" class="btn btn-excel" onclick="exportarExcel()">Descargar Reporte Excel</button>
            </div>
        </form>

        <div class="history">
            <div class="section-title">
                Historial de Registros
                <button class="btn-danger-soft" onclick="borrarTodo()">BORRAR TODO EL AÑO</button>
            </div>
            <table>
                <thead><tr><th>Fecha</th><th>Placa</th><th>Conductor</th><th>Acción</th></tr></thead>
                <tbody id="tbodyHistorial"></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const STORAGE_KEY = "pmt_consignas_2026";
    let historial = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let fotoBase64 = "";

    function initCanvas(id) {
        const canvas = document.getElementById(id);
        const ctx = canvas.getContext("2d");
        canvas.width = canvas.offsetWidth;
        canvas.height = canvas.offsetHeight;
        ctx.lineWidth = 2; ctx.lineCap = "round"; ctx.strokeStyle = "#000";
        let drawing = false;

        const getPos = e => {
            const r = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - r.left, y: clientY - r.top };
        };

        const start = e => { drawing = true; ctx.beginPath(); const p = getPos(e); ctx.moveTo(p.x, p.y); };
        const move = e => { if(!drawing) return; e.preventDefault(); const p = getPos(e); ctx.lineTo(p.x, p.y); ctx.stroke(); };

        canvas.addEventListener("mousedown", start);
        canvas.addEventListener("mousemove", move);
        window.addEventListener("mouseup", () => drawing = false);
        canvas.addEventListener("touchstart", start);
        canvas.addEventListener("touchmove", move);
    }

    initCanvas("canvasAgente"); initCanvas("canvasConductor");

    function limpiar(id) {
        const c = document.getElementById(id);
        c.getContext("2d").clearRect(0,0,c.width,c.height);
    }

    function previewFoto(e) {
        const reader = new FileReader();
        reader.onload = () => {
            fotoBase64 = reader.result;
            const img = document.getElementById('preview');
            img.src = fotoBase64; img.style.display = "block";
        };
        reader.readAsDataURL(e.target.files[0]);
    }

    function guardar() {
        const data = {
            id: Date.now(), // ID único para poder borrar
            fecha: document.getElementById('fecha').value,
            hora: document.getElementById('hora').value,
            conductor: document.getElementById('c_nombre').value,
            licencia: document.getElementById('c_licencia').value,
            dpi: document.getElementById('c_dpi').value,
            placa: document.getElementById('v_placa').value,
            marca: document.getElementById('v_marca').value,
            color: document.getElementById('v_color').value,
            nit: document.getElementById('v_nit').value,
            motivo: document.getElementById('h_motivo').value,
            obs: document.getElementById('h_obs').value
        };

        if(!data.placa || !data.fecha) return alert("Complete Fecha y Placa");
        
        historial.push(data);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historial));
        renderTabla();
        document.getElementById('formConsignacion').reset();
        document.getElementById('preview').style.display = "none";
        fotoBase64 = "";
        limpiar('canvasAgente'); limpiar('canvasConductor');
        alert("Registro guardado.");
    }

    function renderTabla() {
        const tbody = document.getElementById('tbodyHistorial');
        tbody.innerHTML = historial.slice().reverse().map((r, index) => `
            <tr>
                <td>${r.fecha}</td>
                <td>${r.placa}</td>
                <td>${r.conductor}</td>
                <td><button class="btn-delete-row" onclick="borrarFila(${r.id})">X</button></td>
            </tr>
        `).join('');
    }

    // BORRAR SOLO UNA FILA
    function borrarFila(id) {
        if(!confirm("¿Deseas eliminar este registro de prueba?")) return;
        historial = historial.filter(item => item.id !== id);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(historial));
        renderTabla();
    }

    // BORRAR TODO EL HISTORIAL
    function borrarTodo() {
        if(!confirm("⚠️ ¿ESTÁS SEGURO? Esto borrará TODA la base de datos del año 2026. Úsalo solo para limpiar las pruebas.")) return;
        historial = [];
        localStorage.removeItem(STORAGE_KEY);
        renderTabla();
    }

    function generarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFontSize(14); doc.text("BOLETA DE CONSIGNACIÓN - PMT CHIMALTENANGO", 105, 15, {align:'center'});
        doc.setFontSize(10); doc.text(`Fecha: ${document.getElementById('fecha').value} | Hora: ${document.getElementById('hora').value}`, 20, 25);
        doc.text(`CONDUCTOR: ${document.getElementById('c_nombre').value}`, 20, 35);
        doc.text(`PLACA: ${document.getElementById('v_placa').value} | MARCA: ${document.getElementById('v_marca').value}`, 20, 42);
        doc.text("MOTIVO:", 20, 52);
        doc.text(doc.splitTextToSize(document.getElementById('h_motivo').value, 170), 20, 57);
        if(fotoBase64) {
            doc.text("EVIDENCIA FOTOGRÁFICA:", 20, 80);
            doc.addImage(fotoBase64, 'JPEG', 20, 85, 60, 45);
        }
        const sigA = document.getElementById('canvasAgente').toDataURL();
        const sigC = document.getElementById('canvasConductor').toDataURL();
        doc.addImage(sigA, 'PNG', 20, 140, 50, 20);
        doc.addImage(sigC, 'PNG', 120, 140, 50, 20);
        doc.save(`Boleta_${document.getElementById('v_placa').value}.pdf`);
    }

    function exportarExcel() {
        if(historial.length === 0) return alert("No hay datos");
        const ws = XLSX.utils.json_to_sheet(historial);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Consignas");
        XLSX.writeFile(wb, "REPORTE_2026.xlsx");
    }

    renderTabla();
</script>

</body>
</html>
